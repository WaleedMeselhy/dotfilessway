
# Use fortune and cowsay with the random figure
random_figure=$(ls /usr/share/cowsay/cows/ | shuf -n 1)
fortune | cowsay -f "$random_figure"

# base config for oh my zsh
source /usr/share/oh-my-zsh/zshrc
#p10k instant prompt to make terminal open a bit snappier
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi


# Source manjaro config
source ~/.zshrc

# fix for comment color on manjaro zsh theme
ZSH_HIGHLIGHT_STYLES[comment]='fg=blue'

# user-defined overrides
[ -d ~/.config/zsh/config.d/ ] && source <(cat ~/.config/zsh/config.d/*)

# Fix for foot terminfo not installed on most servers
alias ssh="TERM=xterm-256color ssh"
source ~/.config/user-dirs.dirs

# Created by `pipx` on 2025-09-23 15:21:51
export PATH="$PATH:/home/waleed/.local/bin"

[ -f ~/.fzf.zsh ] && source ~/.fzf.zsh

# To customize prompt, run `p10k configure` or edit ~/.p10k.zsh.
[[ ! -f ~/.p10k.zsh ]] || source ~/.p10k.zsh


ZSH_THEME="powerlevel10k/powerlevel10k"

plugins=(
  git
  fzf
  zsh-completions
  fzf-tab
  zsh-autosuggestions
  zsh-syntax-highlighting
  autojump
  zoxide
  history-substring-search
  docker-compose
  nx-completion
  kubectl
)

source $ZSH/oh-my-zsh.sh



# disable sort when completing `git checkout`
zstyle ':completion:*:git-checkout:*' sort false
# set descriptions format to enable group support
# NOTE: don't use escape sequences (like '%F{red}%d%f') here, fzf-tab will ignore them
zstyle ':completion:*:descriptions' format '[%d]'
# set list-colors to enable filename colorizing
zstyle ':completion:*' list-colors ${(s.:.)LS_COLORS}
# force zsh not to show completion menu, which allows fzf-tab to capture the unambiguous prefix
zstyle ':completion:*' menu no
# preview directory's content with eza when completing cd
zstyle ':fzf-tab:complete:cd:*' fzf-preview 'eza -1 --color=always $realpath'
# custom fzf flags
# NOTE: fzf-tab does not follow FZF_DEFAULT_OPTS by default
zstyle ':fzf-tab:*' fzf-flags --color=fg:1,fg+:2 --bind=tab:accept
# To make fzf-tab follow FZF_DEFAULT_OPTS.
# NOTE: This may lead to unexpected behavior since some flags break this plugin. See Aloxaf/fzf-tab#455.
zstyle ':fzf-tab:*' use-fzf-default-opts yes
# switch group using `<` and `>`
zstyle ':fzf-tab:*' switch-group '<' '>'


export NVM_DIR="$HOME/.config/nvm"
[ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"  # This loads nvm
[ -s "$NVM_DIR/bash_completion" ] && \. "$NVM_DIR/bash_completion"  # This loads nvm bash_completion

# Custom deduplication hook with prefix replacement
zshaddhistory() {
    emulate -L zsh
    local line="${1%%$'\n'}"
    
    # Skip empty lines
    [[ -z "$line" ]] && return 1
    
    # Define prefixes that should replace old entries (only keep the latest)
    local -a replace_prefixes=(
        "./manage.py test -v 3 -k"
        "k exec"
        "git checkout ENG-"
        "git checkout -b ENG-"
        "git push -u origin"
        "./utils/commands/maintenance_pod.sh --env production --keep --label"
        "k delete pod"
        "k logs"
        "./manage.py makemigrations --name"
)
    
    # Check if line matches any prefix that should trigger replacement
    local prefix
    for prefix in "${replace_prefixes[@]}"; do
        if [[ "$line" == "$prefix"* ]]; then
            # Remove old entries with same prefix from history file
            if [[ -f "$HISTFILE" ]]; then
                local tmpfile="${HISTFILE}.tmp.$$"
                # Escape dots and other regex special chars for grep
                local escaped_prefix="${prefix//./\\.}"
                escaped_prefix="${escaped_prefix//\*/\\*}"
                escaped_prefix="${escaped_prefix//\[/\\[}"
                grep -v "^: [0-9]*:[0-9];${escaped_prefix}" "$HISTFILE" > "$tmpfile" 2>/dev/null && mv "$tmpfile" "$HISTFILE"
            fi
            return 0  # Add the new command
        fi
    done
    
    # Check for exact duplicates (for commands not in the replace list)
    if fc -ln 1 2>/dev/null | grep -Fxq "$line"; then
        return 1  # Skip exact duplicate
    fi
    
    return 0  # Add to history
}